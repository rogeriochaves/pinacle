# Build stage for code-server
FROM pinacledev/code-server-alpine:4.104.2 AS code-server-builder

# Build stage for postgres
FROM alpine AS pg-builder

RUN apk add --no-cache \
    build-base \
    readline-dev \
    zlib-dev \
    openssl-dev \
    bison \
    flex \
    perl \
    wget

ENV PGVERSION=18.1

RUN wget https://ftp.postgresql.org/pub/source/v${PGVERSION}/postgresql-${PGVERSION}.tar.gz && \
    tar xf postgresql-${PGVERSION}.tar.gz && \
    cd postgresql-${PGVERSION} && \
    ./configure --prefix=/usr/local --without-readline --with-openssl --without-icu && \
    # Remove root restriction
    sed -i 's/if (geteuid() == 0)/if (0)/' src/backend/main/main.c && \
    # Remove tools that won't build on musl (missing linux/fs.h)
    sed -i '/pg_combinebackup/d' src/bin/Makefile && \
    sed -i '/pg_upgrade/d' src/bin/Makefile && \
    \
    make -j4 && \
    make install

# Create postgres user ONLY in build stage (here we can su/chown freely)
RUN adduser -D -h /var/lib/postgresql -s /bin/sh postgres && \
    mkdir -p /build-data && \
    chown -R postgres:postgres /build-data && \
    su postgres -c "/usr/local/bin/initdb -D /build-data --auth=trust"

# Runtime stage
FROM node:22-alpine

# UTF-8 for better tmux rendering and system-wide
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8

# Install base development tools and runtime dependencies
RUN apk add --no-cache \
    curl \
    wget \
    git \
    vim \
    htop \
    python3 \
    py3-pip \
    ca-certificates \
    bash \
    shadow \
    sudo \
    openssh-client \
    tar \
    gzip \
    ttyd \
    tmux \
    nginx \
    libarchive-tools \
    openrc

# Install pnpm and essential Node.js tools
RUN npm install -g pnpm

# Set tmux config
RUN echo "set -g status off" >> /etc/tmux.conf

# Copy PostgreSQL from builder stage (binaries + initialized data)
COPY --from=pg-builder /usr/local /usr/local
COPY --from=pg-builder /build-data /var/lib/postgresql/data
# Change to root:root for working with gvisor
RUN chown -R root:root /var/lib/postgresql && chmod -R 700 /var/lib/postgresql/data

# Copy code-server binaries from builder stage
COPY --from=code-server-builder /code-server/release-standalone /usr/local/code-server
RUN ln -s /usr/local/code-server/bin/code-server /usr/local/bin/code-server

# Create workspace directory, and make it the root's default
RUN mkdir -p /workspace
WORKDIR /workspace
RUN mkdir -p /workspace && \
    chown root:root /workspace && \
    sed -i 's|/root|/workspace|' /etc/passwd

# PNPM global setup
ENV PNPM_HOME="/root/.local/share/pnpm" \
    PATH="/root/.local/share/pnpm:/workspace/.local/bin:$PATH" \
    SHELL="bash"
RUN echo 'export PATH="/root/.local/share/pnpm:/workspace/.local/bin:$PATH"' >> /etc/profile
RUN pnpm add -g @anthropic-ai/claude-code
RUN pnpm add -g vibe-kanban

# Configure Nginx for transparent port proxying
RUN mkdir -p /etc/nginx/http.d && \
    rm -f /etc/nginx/http.d/default.conf
COPY docker/config/nginx.conf /etc/nginx/nginx.conf
# Add nginx to OpenRC to start automatically
RUN rc-update add nginx default

CMD ["/sbin/init"]
